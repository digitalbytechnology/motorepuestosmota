function d(){const e=document.querySelector('meta[name="csrf-token"]');return e?e.getAttribute("content"):""}function t(e){return document.getElementById(e)}function m(e){t("okMsg").classList.remove("d-none"),t("okMsg").innerText=e,t("errMsg").classList.add("d-none"),t("errMsg").innerText=""}function o(e){t("errMsg").classList.remove("d-none"),t("errMsg").innerText=e,t("okMsg").classList.add("d-none"),t("okMsg").innerText=""}function i(){t("okMsg").classList.add("d-none"),t("okMsg").innerText="",t("errMsg").classList.add("d-none"),t("errMsg").innerText=""}async function c(e){if(i(),!e)return;const n=await fetch(`/citas/limite?date=${encodeURIComponent(e)}`,{headers:{Accept:"application/json"}}),a=await n.json().catch(()=>({}));if(!n.ok)throw new Error(a.message||"No se pudo cargar el límite");t("max_per_day").value=a.current,t("hint").innerText=a.is_override?`Este día tiene límite especial. Default: ${a.default}`:`Este día usa el límite por defecto: ${a.default}`,t("btnDelete").disabled=!a.is_override}async function u(e,n){i();const a=new FormData;a.append("date",e),a.append("max_per_day",String(n));const s=await fetch("/citas/limite",{method:"POST",headers:{"X-CSRF-TOKEN":d(),Accept:"application/json"},body:a}),r=await s.json().catch(()=>({}));if(!s.ok){if(r.errors){const l=Object.keys(r.errors)[0];throw new Error(r.errors[l][0])}throw new Error(r.message||"No se pudo guardar")}m(r.message||"Guardado"),await c(e)}async function f(e){i();const n=await fetch(`/citas/limite?date=${encodeURIComponent(e)}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":d(),Accept:"application/json"}}),a=await n.json().catch(()=>({}));if(!n.ok)throw new Error(a.message||"No se pudo eliminar");m(a.message||"Eliminado"),await c(e)}document.addEventListener("DOMContentLoaded",async()=>{t("formDayLimit")&&(t("date").addEventListener("change",async e=>{try{await c(e.target.value)}catch(n){o(n.message)}}),t("formDayLimit").addEventListener("submit",async e=>{e.preventDefault();const n=t("date").value,a=t("max_per_day").value;try{await u(n,a)}catch(s){o(s.message)}}),t("btnDelete").addEventListener("click",async()=>{const e=t("date").value;if(e)try{await f(e)}catch(n){o(n.message)}}))});
